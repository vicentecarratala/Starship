<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego LAN</title>
  <style>
    canvas {
      background: #f0f0f0;
      display: block;
      margin: 30px auto;
      border: 2px solid #333;
    }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="500"></canvas>

  <script>
    // 1) Figure out the server IP (the same host serving this page)
    const serverHost = window.location.hostname;   // e.g. "192.168.1.42"
    const serverPort = 3000;                       // your server port
    // 2) Open the WS connection
    const socket = new WebSocket(`ws://${serverHost}:${serverPort}`);

    const canvas = document.getElementById("game");
    const ctx    = canvas.getContext("2d");
    let   myId   = null;
    let   players = {};

    // This is our local state; will get overwritten by
    // server on init if you want to force starting at 100×100
    const myPlayer = {
      x: Math.random() * (canvas.width - 30),
      y: Math.random() * (canvas.height - 30),
      color: '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16),
      name: "Jugador"
    };

    socket.addEventListener("message", event => {
      const data = JSON.parse(event.data);

      if (data.type === "init") {
        // server tells me my ID and the full players list
        myId   = data.id;
        players = data.players;

        // override local state with the one the server has, if you prefer:
        // Object.assign(myPlayer, players[myId]);
        // (or leave as-is, then immediately sendUpdate to push your random pos)

        sendUpdate();
      }

      if (data.type === "players") {
        players = data.players;
      }
    });

    function sendUpdate() {
      if (!myId) return;       // don’t send until we've got an ID
      socket.send(JSON.stringify({
        type: "update",
        state: myPlayer
      }));
    }

    document.addEventListener("keydown", e => {
      const speed = 10;
      switch (e.key) {
        case "ArrowUp":    myPlayer.y -= speed; break;
        case "ArrowDown":  myPlayer.y += speed; break;
        case "ArrowLeft":  myPlayer.x -= speed; break;
        case "ArrowRight": myPlayer.x += speed; break;
        default: return;
      }
      sendUpdate();
    });

    function drawPlayers() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const id in players) {
        const p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 30, 30);
        ctx.fillStyle = "#000";
        ctx.font = "14px Arial";
        ctx.fillText(p.name, p.x, p.y - 6);
      }
    }

    setInterval(drawPlayers, 40);
    setInterval(sendUpdate, 400);
  </script>
</body>
</html>

